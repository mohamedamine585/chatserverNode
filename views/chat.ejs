<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>
<script>
     function sendmessage(){
           
           const message = document.getElementById('messagetext');
           socket.send(message.value);
           document.getElementById('messagetext').value ="";
           document.getElementById('messagetext').focus()
       }
     document.addEventListener('DOMContentLoaded', () =>{
    var chatMessages = document.getElementById('messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;})

    const socket = new WebSocket("ws://localhost:8080/chat/<%= roomid %>");
    socket.addEventListener('open',(event)=>{
        console.log(socket.url)
         console.log("Connection opened!")
    })

     // Listening to messages  ******

    socket.addEventListener('message',(event)=>{

        // Parse Messages ****
    const receivedmessages =  JSON.parse(event.data).msgs 
    if(receivedmessages.length >= 2){
      while(document.getElementById('message')!=null){
        document.getElementById('message').remove()

      }
    }
    let Onemessage ,deleteB,icon;

    // Iterate through messages and render them ****
    console.log(receivedmessages)
     receivedmessages.forEach(rmsg => {

        console.log(rmsg)
          Onemessage = document.createElement('div');   
         Onemessage.textContent = rmsg.text;
         Onemessage.id = 'message'
         Onemessage.setAttribute("message_id",rmsg._id);
         deleteB = document.createElement('button');
         deleteB.id = 'deleteB';
         icon = document.createElement('i')
         icon.className="fas fa-times"
         deleteB.appendChild(icon)
        
         deleteB.addEventListener('click',async()=>{
           await fetch(`http://localhost:8080/messages/${rmsg._id}`,{method:'DELETE'})
         })
         Onemessage.appendChild(deleteB)
         document.getElementById('messages').appendChild(
            Onemessage
         )
     });
        
         scrollToBottom(); 

    });
 
    function scrollToBottom() {
  var chatMessages = document.getElementById('messages');
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

     
     

</script>
<body>
    <style>
        body{
    display: flex;
    
    align-items: center;
    flex-direction:column;
    justify-content: center;
}
   input{

    top: 100%;
    width: 50vw;
    height: 6vh;
    border-radius: 10px 10px 10px;
   } 

 

   #b{
    width: 90px;
    height: 30px;
    border-radius: 10px 10px 10px;
    background-color:rgb(153, 250, 218);
    font-weight: bold;
   }
   #deleteB{
    background-color: white;
    width: 2vw;
    margin-left: 56vw;
   }
   #messages{
    clear: both;
    overflow-y: auto; 
    border: 2px solid;
    height: 70vh;
    width: 70vw;
   }
   #message{
    width: fit-content;
    min-width: 60vw;
    min-height: 5vh;
    border:2px solid;
    margin-top: 10px;
    margin-bottom: 10px;
    margin-left: 10px;
    padding-left: 5px;
    border-radius: 5px;
    white-space: normal;
   }
   #space1{
        height: 20px;
    }
    #space0{
    height: 20px;
   }
    </style>
    

<div id="messages" >
    
    <% messages.forEach(message => { %>
        <div id="message" message_id = "<% message._id %>"><%= message.text %></div>
      <% }); %>
</div>
<div id="space0">

</div>
<div>
    <input  type="text" placeholder="Type your message here" id="messagetext">
</div>


<div id="space1"></div>
<div id="send">
    <button id="b" onClick="sendmessage()"> Send  </button>

</div>
</body>